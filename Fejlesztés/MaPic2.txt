import sys
import os
import json
from PyQt6.QtWidgets import (
    QApplication, QWidget, QVBoxLayout, QHBoxLayout,
    QLabel, QTextBrowser, QPushButton, QSplitter, QFileDialog
)
from PyQt6.QtGui import QPixmap
from PyQt6.QtCore import Qt
from PIL import Image
import exifread

class ImageViewer(QWidget):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("MaPic ‚Äì Majika Picture Viewer")
        self.image_files = []
        self.current_index = 0

        # --- Main layout ---
        self.splitter = QSplitter(Qt.Orientation.Vertical)
        
        # Image display
        self.image_label = QLabel("No image loaded")
        self.image_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.splitter.addWidget(self.image_label)

        # Metadata display
        self.meta_text = QTextBrowser()
        self.splitter.addWidget(self.meta_text)
        
        # Buttons
        btn_layout = QHBoxLayout()
        self.btn_open = QPushButton("Open Folder")
        self.btn_open.clicked.connect(self.open_folder)
        self.btn_prev = QPushButton("‚óÄ Previous")
        self.btn_prev.clicked.connect(self.show_prev)
        self.btn_next = QPushButton("Next ‚ñ∂")
        self.btn_next.clicked.connect(self.show_next)
        self.btn_save = QPushButton("Save Metadata")
        self.btn_save.clicked.connect(self.save_meta)
        
        for b in [self.btn_open, self.btn_prev, self.btn_next, self.btn_save]:
            btn_layout.addWidget(b)

        main_layout = QVBoxLayout()
        main_layout.addWidget(self.splitter)
        main_layout.addLayout(btn_layout)
        self.setLayout(main_layout)

        # --- Automatically load current folder ---
        self.load_current_folder()

    # --- Folder loading ---
    def load_current_folder(self):
        folder = os.getcwd()
        self.image_files = sorted(
            [os.path.join(folder, f) for f in os.listdir(folder)
             if f.lower().endswith((".png",".jpg",".jpeg"))]
        )
        if self.image_files:
            self.current_index = 0
            self.show_image(self.image_files[self.current_index])

    def open_folder(self):
        folder = QFileDialog.getExistingDirectory(self, "Select folder")
        if folder:
            self.image_files = sorted(
                [os.path.join(folder, f) for f in os.listdir(folder)
                 if f.lower().endswith((".png",".jpg",".jpeg"))]
            )
            self.current_index = 0
            if self.image_files:
                self.show_image(self.image_files[self.current_index])

    # --- Image display ---
    def show_image(self, fname):
        pixmap = QPixmap(fname)
        scaled = pixmap.scaled(
            self.image_label.size(),
            Qt.AspectRatioMode.KeepAspectRatio,
            Qt.TransformationMode.SmoothTransformation
        )
        self.image_label.setPixmap(scaled)
        # Update metadata
        result = extract_prompts(fname)
        style = """
        <style>
        .key { font-weight:bold; color:darkblue; }
        .center { text-align:center; display:block; }
        </style>
        """
        meta_info = f"""
        {style}
        <div class="center">{os.path.basename(fname)}</div><br>
        <span class="key">‚úÖ Prompt:</span> {result[0]}<br>
        <span class="key">üö´ Negative Prompt:</span> {result[1]}<br>
        <span class="key">üì¶ Checkpoint:</span> {result[2]}<br>
        <span class="key">üîÅ Sampler:</span> {result[3]} &nbsp; 
        <span class="key">üìà Scheduler:</span> {result[4]} &nbsp;
        <span class="key">üìè Steps:</span> {result[5]}<br>
        <span class="key">üéØ CFG Scale:</span> {result[6]} &nbsp;
        <span class="key">üé≤ Seed:</span> {result[7]} &nbsp;
        <span class="key">üåÄ Denoise:</span> {result[8]}<br>
        <span class="key">üß† VAE:</span> {result[9]}<br>
        <span class="key">‚ú® LoRA:</span> {result[10]}
        """
        self.meta_text.setHtml(meta_info)

    # --- Navigation ---
    def show_next(self):
        if self.image_files and self.current_index < len(self.image_files)-1:
            self.current_index += 1
            self.show_image(self.image_files[self.current_index])

    def show_prev(self):
        if self.image_files and self.current_index > 0:
            self.current_index -= 1
            self.show_image(self.image_files[self.current_index])

    # --- Save metadata ---
    def save_meta(self):
        if not self.image_files: return
        fname = self.image_files[self.current_index]
        result = extract_prompts(fname)
        txt_name = os.path.splitext(fname)[0]+".txt"
        with open(txt_name, "w", encoding="utf-8") as f:
            f.write(f"{os.path.basename(fname)}\n")
            f.write(f"‚úÖ Prompt: {result[0]}\n")
            f.write(f"üö´ Negative Prompt: {result[1]}\n")
            f.write(f"üì¶ Checkpoint: {result[2]}\n")
            f.write(f"üîÅ Sampler: {result[3]}\n")
            f.write(f"üìà Scheduler: {result[4]}\n")
            f.write(f"üìè Steps: {result[5]}\n")
            f.write(f"üéØ CFG Scale: {result[6]}\n")
            f.write(f"üé≤ Seed: {result[7]}\n")
            f.write(f"üåÄ Denoise: {result[8]}\n")
            f.write(f"üß† VAE: {result[9]}\n")
            f.write(f"‚ú® LoRA: {result[10]}\n")

# --- Prompt extraction for PNG/JPG ---
def extract_prompts(fname):
    ext = os.path.splitext(fname)[1].lower()
    if ext == ".png":
        return extract_prompts_png(fname)
    elif ext in (".jpg",".jpeg"):
        return extract_prompts_jpg(fname)
    else:
        return ("N/A","N/A","-","-","-","-","-","-","-","-","-")

def extract_prompts_png(fname):
    try:
        img = Image.open(fname)
        metadata = img.info
        raw_prompt = metadata.get("prompt", None)
        if not raw_prompt:
            return ("N/A","N/A","-","-","-","-","-","-","-","-","-")
        prompt_json = json.loads(raw_prompt)
        texts = [v.get("text","-") for k,v in prompt_json.items() if isinstance(v, dict)]
        pos = texts[0] if len(texts)>0 else "-"
        neg = texts[1] if len(texts)>1 else "-"
        ckpt = next((v.get("ckpt_name","-") for k,v in prompt_json.items() if isinstance(v,dict) and "ckpt_name" in v),"-")
        sampler = next((v.get("sampler_name","-") for k,v in prompt_json.items() if isinstance(v,dict) and "sampler_name" in v),"-")
        scheduler = next((v.get("scheduler","-") for k,v in prompt_json.items() if isinstance(v,dict) and "scheduler" in v),"-")
        step = next((v.get("steps","-") for k,v in prompt_json.items() if isinstance(v,dict) and "steps" in v),"-")
        cfg = next((v.get("cfg","-") for k,v in prompt_json.items() if isinstance(v,dict) and "cfg" in v),"-")
        seed = next((v.get("seed","-") for k,v in prompt_json.items() if isinstance(v,dict) and "seed" in v),"-")
        denoise = next((v.get("denoise","-") for k,v in prompt_json.items() if isinstance(v,dict) and "denoise" in v),"-")
        vae = next((v.get("vae_name","-") for k,v in prompt_json.items() if isinstance(v,dict) and "vae_name" in v),"-")
        lora = next((v.get("lora_name","-") for k,v in prompt_json.items() if isinstance(v,dict) and "lora_name" in v),"-")
        return (pos,neg,ckpt,sampler,scheduler,step,cfg,seed,denoise,vae,lora)
    except Exception as e:
        return (f"Error: {e}","N/A","-","-","-","-","-","-","-","-","-")

def extract_prompts_jpg(fname):
    try:
        with open(fname,'rb') as f:
            tags = exifread.process_file(f, details=False, stop_tag="UserComment")
            user_comment = tags.get("EXIF UserComment", None)
            if not user_comment:
                return ("N/A","N/A","-","-","-","-","-","-","-","-","-")
            raw_prompt = user_comment.values
            if isinstance(raw_prompt, bytes):
                raw_prompt = raw_prompt.decode('utf-8',errors='ignore')
            prompt_json = json.loads(raw_prompt)
            texts = [v.get("text","-") for k,v in prompt_json.items() if isinstance(v, dict)]
            pos = texts[0] if len(texts)>0 else "-"
            neg = texts[1] if len(texts)>1 else "-"
            ckpt = next((v.get("ckpt_name","-") for k,v in prompt_json.items() if isinstance(v,dict) and "ckpt_name" in v),"-")
            sampler = next((v.get("sampler_name","-") for k,v in prompt_json.items() if isinstance(v,dict) and "sampler_name" in v),"-")
            scheduler = next((v.get("scheduler","-") for k,v in prompt_json.items() if isinstance(v,dict) and "scheduler" in v),"-")
            step = next((v.get("steps","-") for k,v in prompt_json.items() if isinstance(v,dict) and "steps" in v),"-")
            cfg = next((v.get("cfg","-") for k,v in prompt_json.items() if isinstance(v,dict) and "cfg" in v),"-")
            seed = next((v.get("seed","-") for k,v in prompt_json.items() if isinstance(v,dict) and "seed" in v),"-")
            denoise = next((v.get("denoise","-") for k,v in prompt_json.items() if isinstance(v,dict) and "denoise" in v),"-")
            vae = next((v.get("vae_name","-") for k,v in prompt_json.items() if isinstance(v,dict) and "vae_name" in v),"-")
            lora = next((v.get("lora_name","-") for k,v in prompt_json.items() if isinstance(v,dict) and "lora_name" in v),"-")
            return (pos,neg,ckpt,sampler,scheduler,step,cfg,seed,denoise,vae,lora)
    except Exception as e:
        return (f"Error: {e}","N/A","-","-","-","-","-","-","-","-","-")

# --- Run application ---
if __name__ == "__main__":
    app = QApplication(sys.argv)
    viewer = ImageViewer()
    viewer.resize(1000,700)
    viewer.show()
    sys.exit(app.exec())
